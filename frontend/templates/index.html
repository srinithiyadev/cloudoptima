<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudOptima Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1><i class="fas fa-cloud"></i> CloudOptima Dashboard</h1>
            <div class="header-info">
                <p><i class="fas fa-clock"></i> Last scan: <span id="last-scan">{{ last_scan }}</span></p>
                <button onclick="runScan()" class="btn-scan">
                    <i class="fas fa-sync-alt"></i> Run Scan
                </button>
                <button onclick="toggleDemoMode()" class="btn-demo" id="demo-btn">
                    <i class="fas fa-play-circle"></i> Demo Mode: ON
                </button>
            </div>
        </header>

        <!-- AWS Connection Panel -->
        <div class="aws-connect-card" id="aws-connect">
            <h3><i class="fab fa-aws"></i> Connect AWS Account (Optional)</h3>
            <p>Connect to see your real AWS cost data and idle instances</p>
            <div class="aws-inputs">
                <input type="text" id="aws-key" placeholder="AWS Access Key ID">
                <input type="password" id="aws-secret" placeholder="AWS Secret Key">
                <button onclick="connectAWS()" class="btn-connect">
                    <i class="fas fa-plug"></i> Connect AWS
                </button>
            </div>
            <p class="small-note">
                <i class="fas fa-shield-alt"></i> Keys are used temporarily and never stored
            </p>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card">
                <h3><i class="fas fa-server"></i> Total Resources</h3>
                <p class="big-number" id="total-resources">0</p>
            </div>
            <div class="card">
                <h3><i class="fas fa-bed"></i> Idle Resources</h3>
                <p class="big-number" id="idle-resources">0</p>
            </div>
            <div class="card highlight">
                <h3><i class="fas fa-money-bill-wave"></i> Monthly Cost</h3>
                <p class="big-number" id="monthly-cost">{{ savings }}</p>
                <p class="cost-source" id="cost-source">(Demo Data)</p>
            </div>
        </div>

        <!-- Cost Chart -->
        <div class="chart-section">
            <h2><i class="fas fa-chart-line"></i> AWS Cost Overview</h2>
            <canvas id="costChart"></canvas>
        </div>

        <!-- Cloud Tabs -->
        <div class="cloud-tabs">
            <button class="tab-btn active" onclick="showCloud('aws')">
                <i class="fab fa-aws"></i> AWS
            </button>
            <button class="tab-btn" onclick="showCloud('azure')">
                <i class="fab fa-microsoft"></i> Azure
            </button>
            <button class="tab-btn" onclick="showCloud('gcp')">
                <i class="fab fa-google"></i> Google Cloud
            </button>
        </div>

        <!-- Resources Table -->
        <div class="table-section">
            <h2><i class="fas fa-list"></i> Cloud Resources <span id="data-source">(Demo Data)</span></h2>
            <table id="resources-table">
                <thead>
                    <tr>
                        <th>Resource ID</th>
                        <th>Name</th>
                        <th>Cloud</th>
                        <th>Status</th>
                        <th>Days Running</th>
                        <th>Monthly Cost</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resources-body">
                    {% for instance in instances %}
                    <tr>
                        <td>{{ instance.id }}</td>
                        <td>{{ instance.name }}</td>
                        <td><span class="cloud-badge {{ instance.cloud }}">{{ instance.cloud|upper }}</span></td>
                        <td>
                            <span class="status-badge {{ instance.status }}">
                                {{ instance.status|upper }}
                            </span>
                        </td>
                        <td>{{ instance.cpu }}</td>
                        <td>{{ instance.cost }}</td>
                        <td>
                            {% if instance.status == 'idle' %}
                            <button class="btn-action" onclick="sendAlert('{{ instance.id }}')">
                                <i class="fas fa-bell"></i> Alert
                            </button>
                            {% else %}
                            <span class="text-muted">No action</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <footer>
            <p>CloudOptima &copy; 2024 | Multi-Cloud Cost Optimization Tool</p>
            <p class="footer-info">
                <i class="fas fa-info-circle"></i> 
                Connect AWS to see real cost data. Azure & GCP show demo data.
            </p>
        </footer>
    </div>

    <script>
        // Chart for cost visualization
        const ctx = document.getElementById('costChart').getContext('2d');
        const costChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Will be populated with dates
                datasets: [{
                    label: 'AWS Daily Cost (USD)',
                    data: [],
                    borderColor: '#36a2eb',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {display: true, text: 'AWS Daily Costs (Last 30 Days)'}
                }
            }
        });

        // AWS Connection
        async function connectAWS() {
            const key = document.getElementById('aws-key').value;
            const secret = document.getElementById('aws-secret').value;
            
            if (!key || !secret) {
                alert('Please enter AWS Access Key and Secret Key');
                return;
            }

            const connectBtn = document.querySelector('.btn-connect');
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            connectBtn.disabled = true;
            
            try {
                // 1. Fetch cost data
                const costResponse = await fetch('https://cloudoptima.onrender.com/api/aws/cost', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        accessKeyId: key,
                        secretAccessKey: secret
                    })
                });
                
                const costData = await costResponse.json();
                if (costData.error) throw new Error(costData.error);
                
                // 2. Fetch AWS instances
                const instancesResponse = await fetch('https://cloudoptima.onrender.com/api/aws/instances', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        accessKeyId: key,
                        secretAccessKey: secret
                    })
                });
                
                const instancesData = await instancesResponse.json();
                if (instancesData.error) throw new Error(instancesData.error);
                
                // Update dashboard with real data
                document.getElementById('monthly-cost').innerText = 
                    costData.total_cost || '0';
                document.getElementById('cost-source').innerText = '(Real AWS Data)';
                document.getElementById('data-source').innerText = '(Real AWS Instances)';
                
                // Update summary cards
                document.getElementById('idle-resources').innerText = 
                    instancesData.total_instances || '0';
                document.getElementById('total-resources').innerText = 
                    instancesData.total_instances || '0';
                
                // Update chart with real dates and costs
                costChart.data.labels = costData.daily_costs?.map(d => d.date.substring(5)) || [];
                costChart.data.datasets[0].data = costData.daily_costs?.map(d => parseFloat(d.cost)) || [];
                costChart.update();
                
                // Update resources table with AWS instances
                updateResourcesTable(instancesData.idle_instances);
                
                alert('✅ AWS connected! Found ' + instancesData.total_instances + ' idle instances.');
                
            } catch (error) {
                console.error(error);
                alert('❌ Failed to connect AWS: ' + error.message);
            } finally {
                connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect AWS';
                connectBtn.disabled = false;
            }
        }

        // Function to update resources table with AWS instances
        function updateResourcesTable(instances) {
            const tableBody = document.getElementById('resources-body');
            tableBody.innerHTML = ''; // Clear demo data
            
            if (!instances || instances.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align:center; padding:20px;">
                            <i class="fas fa-check-circle" style="color:#28a745;"></i>
                            No idle instances found in your AWS account.
                        </td>
                    </tr>`;
                return;
            }
            
            instances.forEach(instance => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${instance.id}</td>
                    <td>${instance.name || 'No Name'}</td>
                    <td><span class="cloud-badge aws">AWS</span></td>
                    <td><span class="status-badge idle">IDLE</span></td>
                    <td>${instance.days_running} days</td>
                    <td>$${instance.estimated_savings || '50'}/month</td>
                    <td>
                        <button class="btn-action" onclick="sendAlert('${instance.id}')">
                            <i class="fas fa-bell"></i> Alert
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Demo mode toggle
        function toggleDemoMode() {
            const btn = document.getElementById('demo-btn');
            const isDemo = btn.innerText.includes('ON');
            
            if (isDemo) {
                btn.innerHTML = '<i class="fas fa-database"></i> Demo Mode: OFF';
                btn.style.background = '#28a745';
                document.getElementById('cost-source').innerText = '(Real AWS Data)';
            } else {
                btn.innerHTML = '<i class="fas fa-play-circle"></i> Demo Mode: ON';
                btn.style.background = '#007bff';
                document.getElementById('cost-source').innerText = '(Demo Data)';
                document.getElementById('data-source').innerText = '(Demo Data)';
                location.reload(); // Reload to show demo data
            }
        }

        // Cloud tabs
        function showCloud(cloud) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // Filter table by cloud (to implement)
            console.log('Showing:', cloud);
        }

        // Existing functions
        function runScan() {
            fetch('/api/scan', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(`Scan complete: ${data.message}`);
                        location.reload();
                    }
                });
        }

        function sendAlert(resourceId) {
            alert(`Alert sent to team for resource: ${resourceId}`);
        }
    </script>
</body>
</html>