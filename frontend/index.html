<!DOCTYPE html>
<html lang="en">
<head>
    <script>
    // PROTECT DASHBOARD - CHECK LOGIN
    if (!localStorage.getItem('demo_mode') && !localStorage.getItem('token')) {
        window.location.href = '/login.html';
    }
    // AWS Connection Functions
function connectAWS() {
    const accessKey = document.getElementById('aws-key').value.trim();
    const secretKey = document.getElementById('aws-secret').value.trim();
    const region = document.getElementById('aws-region').value;
    
    if (!accessKey || !secretKey) {
        alert('Please enter both Access Key and Secret Key');
        return;
    }
    
    // Show loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
    btn.disabled = true;
    
    // Simulate connection (since backend not ready)
    setTimeout(() => {
        // Hide form, show connected info
        document.getElementById('awsForm').style.display = 'none';
        document.getElementById('connectedInfo').style.display = 'block';
        
        // Update status badge
        const statusBadge = document.getElementById('awsStatus');
        statusBadge.innerHTML = '<i class="fas fa-circle"></i> Connected';
        statusBadge.style.background = '#10b981';
        
        // Show account info
        document.getElementById('connectedAccount').textContent = accessKey.substring(0, 8) + '...';
        document.getElementById('connectedRegion').textContent = region;
        
        // Save to localStorage
        localStorage.setItem('aws_connected', 'true');
        localStorage.setItem('aws_region', region);
        
        // Restore button
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        // Show success message
        alert('‚úÖ AWS Account connected! Auto-scanner will now monitor for idle resources.');
        
        // Update the data source indicator
        document.getElementById('cost-source').innerText = '(Real AWS Data)';
        document.getElementById('data-source').innerText = '(Connected to AWS)';
        
        // Start auto-refresh
        startAutoRefresh();
    }, 1500);
}

function disconnectAWS() {
    if (confirm('Disconnect AWS account? Auto-alerts will stop.')) {
        // Show form, hide connected info
        document.getElementById('awsForm').style.display = 'block';
        document.getElementById('connectedInfo').style.display = 'none';
        
        // Update status badge
        const statusBadge = document.getElementById('awsStatus');
        statusBadge.innerHTML = '<i class="fas fa-circle"></i> Not Connected';
        statusBadge.style.background = '#f97316';
        
        // Clear localStorage
        localStorage.removeItem('aws_connected');
        localStorage.removeItem('aws_region');
        
        // Update data source indicator
        document.getElementById('cost-source').innerText = '(Demo Data)';
        document.getElementById('data-source').innerText = '(Demo Data)';
        
        // Stop auto-refresh
        stopAutoRefresh();
        
        // Reload demo data
        loadDemoData();
        
        alert('üîå AWS account disconnected.');
    }
}

// Check if AWS was previously connected
document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('aws_connected')) {
        document.getElementById('awsForm').style.display = 'none';
        document.getElementById('connectedInfo').style.display = 'block';
        
        const statusBadge = document.getElementById('awsStatus');
        statusBadge.innerHTML = '<i class="fas fa-circle"></i> Connected';
        statusBadge.style.background = '#10b981';
        
        document.getElementById('connectedRegion').textContent = localStorage.getItem('aws_region') || 'us-east-1';
        document.getElementById('connectedAccount').textContent = 'Previously Connected';
    }
});
// Auto-Alert Functions
function saveAlertSettings() {
    const email = document.getElementById('alertEmail').value;
    const frequency = document.getElementById('scanFrequency').value;
    const enabled = document.getElementById('autoAlertToggle').checked;
    
    // Save to localStorage
    localStorage.setItem('alert_email', email);
    localStorage.setItem('scan_frequency', frequency);
    localStorage.setItem('alerts_enabled', enabled);
    
    alert('‚úÖ Settings saved! Auto-scanner will run every ' + frequency + ' hours.');
    
    // Update status
    document.getElementById('alertStatus').innerText = enabled ? 'ACTIVE' : 'DISABLED';
    document.getElementById('alertStatus').style.background = enabled ? '#10b981' : '#ef4444';
}

// Updated Test Alert Function - SENDS REAL EMAIL!
async function testAlert() {
    const email = document.getElementById('alertEmail').value;
    
    if (!email) {
        alert('Please enter an email address first');
        return;
    }
    
    // Show sending state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    btn.disabled = true;
    
    try {
        // Call your backend to send REAL email
        const response = await fetch('https://cloudoptima.onrender.com/api/email/test-alert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('‚úÖ Test alert sent! Check your inbox at ' + email);
            
            // Update the stats
            const alertsSent = document.getElementById('alertsSent');
            alertsSent.innerText = parseInt(alertsSent.innerText) + 1;
            
            // Add to recent alerts
            const recentDiv = document.getElementById('recentAlerts');
            const newAlert = document.createElement('div');
            newAlert.style.cssText = 'padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 14px;';
            newAlert.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> Test Alert - Just now';
            recentDiv.insertBefore(newAlert, recentDiv.firstChild);
        } else {
            alert('‚ùå Failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Test alert error:', error);
        alert('‚ùå Could not connect to backend. Make sure your backend is running on Render.');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
    
    // Show sending
    const btn = event.target;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    btn.disabled = true;
    
    // Simulate sending
    setTimeout(() => {
        alert('‚úÖ Test alert sent to ' + email + '! Check your inbox.');
        
        // Update alerts sent count
        const alertsSent = document.getElementById('alertsSent');
        alertsSent.innerText = parseInt(alertsSent.innerText) + 1;
        
        // Add to recent alerts
        const recentDiv = document.getElementById('recentAlerts');
        const newAlert = document.createElement('div');
        newAlert.style.cssText = 'padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 14px;';
        newAlert.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> Test Alert - Just now';
        recentDiv.insertBefore(newAlert, recentDiv.firstChild);
        
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Test Alert';
        btn.disabled = false;
    }, 1500);


// Load saved settings on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load alert settings
    const savedEmail = localStorage.getItem('alert_email');
    const savedFrequency = localStorage.getItem('scan_frequency');
    const alertsEnabled = localStorage.getItem('alerts_enabled');
    
    if (savedEmail) {
        document.getElementById('alertEmail').value = savedEmail;
    }
    
    if (savedFrequency) {
        document.getElementById('scanFrequency').value = savedFrequency;
    }
    
    if (alertsEnabled !== null) {
        document.getElementById('autoAlertToggle').checked = alertsEnabled === 'true';
        document.getElementById('alertStatus').innerText = alertsEnabled === 'true' ? 'ACTIVE' : 'DISABLED';
        document.getElementById('alertStatus').style.background = alertsEnabled === 'true' ? '#10b981' : '#ef4444';
    }
    
    // Update last scan time
    document.getElementById('lastScanTime').innerText = new Date().toLocaleTimeString();
});
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudOptima Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1><i class="fas fa-cloud"></i> CloudOptima Dashboard</h1>
            <div class="header-info">
                <p><i class="fas fa-clock"></i> Last scan: <span id="last-scan">Just now</span></p>
                <button onclick="runScan()" class="btn-scan">
                    <i class="fas fa-sync-alt"></i> Run Scan
                </button>
                <button onclick="toggleDemoMode()" class="btn-demo" id="demo-btn">
                    <i class="fas fa-play-circle"></i> Demo Mode: ON
                </button>
            </div>
            <div style="position: absolute; top: 20px; right: 30px; display: flex; align-items: center; gap: 15px;">
    <span style="color: #1e293b;" id="userEmail">
        <i class="fas fa-user-circle"></i> 
        <span id="userEmailText">demo@cloudoptima.com</span>
    </span>
    <button onclick="logout()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>
</div>
        </header>

        <!-- AWS Connection Panel -->
<div class="aws-connect-card" id="aws-connect">
    <h3><i class="fab fa-aws"></i> Connect Your AWS Account</h3>
    <p>Connect to enable auto-alerts for idle resources</p>

    <!-- AUTO-ALERT SETTINGS SECTION - Add this after AWS Connect -->
<div class="alert-settings-card" style="background: white; border-radius: 12px; padding: 25px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
        <i class="fas fa-bell" style="color: #4f46e5;"></i>
        Auto-Alert Settings
        <span id="alertStatus" style="background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-left: 10px;">ACTIVE</span>
    </h3>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
        <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
            <i class="fas fa-clock" style="color: #4f46e5; font-size: 20px;"></i>
            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Last Scan</p>
            <p id="lastScanTime" style="font-weight: 600; color: #1e293b;">Just now</p>
        </div>
        <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
            <i class="fas fa-server" style="color: #4f46e5; font-size: 20px;"></i>
            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Idle Found</p>
            <p id="idleCount" style="font-weight: 600; color: #1e293b;">3</p>
        </div>
        <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
            <i class="fas fa-envelope" style="color: #4f46e5; font-size: 20px;"></i>
            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Alerts Sent</p>
            <p id="alertsSent" style="font-weight: 600; color: #1e293b;">5</p>
        </div>
    </div>
    
    <div style="border-top: 2px solid #e2e8f0; padding-top: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Alert Email</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="email" id="alertEmail" value="srinithiyadevops@gmail.com" 
                           style="flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <span id="emailVerified" style="color: #10b981;"><i class="fas fa-check-circle"></i></span>
                </div>
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Scan Frequency</label>
                <select id="scanFrequency" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <option value="6">Every 6 hours</option>
                    <option value="12">Every 12 hours</option>
                    <option value="24">Every 24 hours</option>
                </select>
            </div>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 15px; align-items: center;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="autoAlertToggle" checked>
                <span>Enable Auto-Alerts</span>
            </label>
            <button onclick="saveAlertSettings()" style="padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-save"></i> Save Settings
            </button>
            <button onclick="testAlert()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-paper-plane"></i> Send Test Alert
            </button>
        </div>
        
        <!-- Recent Alerts -->
        <div style="margin-top: 20px; background: #f8fafc; padding: 15px; border-radius: 8px;">
            <p style="font-weight: 600; margin-bottom: 10px;"><i class="fas fa-history"></i> Recent Alerts</p>
            <div id="recentAlerts">
                <div style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 14px;">
                    <i class="fas fa-check-circle" style="color: #10b981;"></i> 
                    dev-server-1 (EC2) - 2 hours ago
                </div>
                <div style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 14px;">
                    <i class="fas fa-check-circle" style="color: #10b981;"></i> 
                    old-database (RDS) - 5 hours ago
                </div>
                <div style="padding: 8px; font-size: 14px;">
                    <i class="fas fa-check-circle" style="color: #10b981;"></i> 
                    unattached-volume (EBS) - 1 day ago
                </div>
            </div>
        </div>
    </div>
</div>
    
    <!-- Connection Status Badge -->
    <div style="margin-bottom: 15px;">
        <span id="awsStatus" style="background: #f97316; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
            <i class="fas fa-circle"></i> Not Connected
        </span>
    </div>
    
    <!-- Connection Form -->
    <div id="awsForm">
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">AWS Access Key ID</label>
            <input type="text" id="aws-key" placeholder="AKIAXXXXXXXXXXXXXXXX" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">AWS Secret Access Key</label>
            <input type="password" id="aws-secret" placeholder="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Region</label>
            <select id="aws-region" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                <option value="us-east-1">US East (N. Virginia)</option>
                <option value="us-west-2">US West (Oregon)</option>
                <option value="eu-west-1">EU (Ireland)</option>
            </select>
        </div>
        
        <button onclick="connectAWS()" class="btn-connect" style="width: 100%;">
            <i class="fas fa-plug"></i> Connect AWS Account
        </button>
    </div>
    
    <!-- Connected Info (Hidden by default) -->
    <div id="connectedInfo" style="display: none; background: #f0fdf4; padding: 20px; border-radius: 8px; margin-top: 15px;">
        <p style="color: #166534;"><i class="fas fa-check-circle"></i> AWS Account Connected!</p>
        <p style="font-size: 14px;">Account: <span id="connectedAccount">********</span></p>
        <p style="font-size: 14px;">Region: <span id="connectedRegion">us-east-1</span></p>
        <p style="font-size: 14px; margin-top: 10px;">
            <i class="fas fa-bell"></i> Auto-alerts: <span style="color: #059669;">Active</span>
        </p>
        <button onclick="disconnectAWS()" style="margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
            <i class="fas fa-unlink"></i> Disconnect
        </button>
    </div>
    
    <p class="small-note">
        <i class="fas fa-shield-alt"></i> Your keys are used only for scanning. We recommend using a read-only IAM user.
    </p>
    <p id="refresh-status" class="small-note" style="display:none;">
        <i class="fas fa-sync-alt"></i> Auto-refresh: <span id="refresh-timer">5:00</span>
    </p>
</div>
       

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card">
                <h3><i class="fas fa-server"></i> Total Resources</h3>
                <p class="big-number" id="total-resources">12</p>
            </div>
            <div class="card">
                <h3><i class="fas fa-bed"></i> Idle Resources</h3>
                <p class="big-number" id="idle-resources">3</p>
            </div>
            <div class="card highlight">
                <h3><i class="fas fa-money-bill-wave"></i> Monthly Cost</h3>
                <p class="big-number" id="monthly-cost">$1,250</p>
                <p class="cost-source" id="cost-source">(Demo Data)</p>
            </div>
        </div>

        <!-- Cost Chart -->
        <div class="chart-section">
            <h2><i class="fas fa-chart-line"></i> AWS Cost Overview</h2>
            <canvas id="costChart"></canvas>
        </div>

        <!-- Cloud Tabs -->
        <div class="cloud-tabs">
            <button class="tab-btn active" onclick="showCloud('aws')">
                <i class="fab fa-aws"></i> AWS
            </button>
            <button class="tab-btn" onclick="showCloud('azure')">
                <i class="fab fa-microsoft"></i> Azure
            </button>
            <button class="tab-btn" onclick="showCloud('gcp')">
                <i class="fab fa-google"></i> Google Cloud
            </button>
        </div>

        <!-- Resources Table -->
        <div class="table-section">
            <h2><i class="fas fa-list"></i> Cloud Resources <span id="data-source">(Demo Data)</span></h2>
            <table id="resources-table">
                <thead>
                    <tr>
                        <th>Resource ID</th>
                        <th>Name</th>
                        <th>Cloud</th>
                        <th>Status</th>
                        <th>Days Running</th>
                        <th>Monthly Cost</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resources-body">
                    <!-- Demo data will be loaded by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <footer>
            <p>CloudOptima &copy; 2024 | Multi-Cloud Cost Optimization Tool</p>
            <p class="footer-info">
                <i class="fas fa-info-circle"></i> 
                Connect AWS to see real cost data. Azure & GCP show demo data.
            </p>
        </footer>
    </div>

    <script>
        // Demo data
        const demoInstances = [
            {id: 'i-0abc123def456', name: 'Web Server', cloud: 'aws', status: 'running', days: '45', cost: '$85'},
            {id: 'i-1def456ghi789', name: 'Database', cloud: 'aws', status: 'idle', days: '120', cost: '$120'},
            {id: 'vm-prod-app-01', name: 'App Server', cloud: 'azure', status: 'running', days: '30', cost: '$95'},
            {id: 'vm-dev-test-02', name: 'Test VM', cloud: 'azure', status: 'idle', days: '90', cost: '$65'},
            {id: 'gcp-instance-1', name: 'Kubernetes Node', cloud: 'gcp', status: 'running', days: '15', cost: '$110'},
            {id: 'gcp-instance-2', name: 'Backup Server', cloud: 'gcp', status: 'idle', days: '200', cost: '$75'}
        ];

        // Auto-refresh variables
        let autoRefreshInterval = null;
        let refreshTimerInterval = null;
        let timeLeft = 300; // 5 minutes in seconds
        let isAWSConnected = false;

        // Load demo data on page load
        function loadDemoData() {
            const tableBody = document.getElementById('resources-body');
            tableBody.innerHTML = '';
            
            demoInstances.forEach(instance => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${instance.id}</td>
                    <td>${instance.name}</td>
                    <td><span class="cloud-badge ${instance.cloud}">${instance.cloud.toUpperCase()}</span></td>
                    <td><span class="status-badge ${instance.status}">${instance.status.toUpperCase()}</span></td>
                    <td>${instance.days} days</td>
                    <td>${instance.cost}/month</td>
                    <td>
                        ${instance.status === 'idle' ? 
                            `<button class="btn-action" onclick="sendAlert('${instance.id}')">
                                <i class="fas fa-bell"></i> Alert
                            </button>` : 
                            `<span class="text-muted">No action</span>`
                        }
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Chart for cost visualization
        const ctx = document.getElementById('costChart').getContext('2d');
        const costChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Will be populated with dates
                datasets: [{
                    label: 'AWS Daily Cost (USD)',
                    data: [],
                    borderColor: '#36a2eb',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {display: true, text: 'AWS Daily Costs (Last 30 Days)'}
                }
            }
        });

        // AWS Connection
        async function connectAWS() {
            const key = document.getElementById('aws-key').value.trim();
            const secret = document.getElementById('aws-secret').value.trim();
            
            console.log('Connecting with key:', key.substring(0, 8) + '...');
            
            if (!key || !secret) {
                alert('Please enter AWS Access Key and Secret Key');
                return;
            }

            const connectBtn = document.querySelector('.btn-connect');
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            connectBtn.disabled = true;
            
            try {
                // 1. Fetch cost data
                console.log('Fetching cost data...');
                const costResponse = await fetch('https://cloudoptima.onrender.com/api/aws/cost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        accessKeyId: key,
                        secretAccessKey: secret
                    })
                });
                
                console.log('Cost response status:', costResponse.status);
                
                if (!costResponse.ok) {
                    const errorText = await costResponse.text();
                    throw new Error(`HTTP ${costResponse.status}: ${errorText.substring(0, 100)}`);
                }
                
                const costData = await costResponse.json();
                console.log('Cost data received:', costData);
                
                if (costData.error) {
                    throw new Error(`AWS Error: ${costData.error}`);
                }
                
                // 2. Fetch AWS instances
                console.log('Fetching instances...');
                const instancesResponse = await fetch('https://cloudoptima.onrender.com/api/aws/instances', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        accessKeyId: key,
                        secretAccessKey: secret
                    })
                });
                
                console.log('Instances response status:', instancesResponse.status);
                
                if (!instancesResponse.ok) {
                    const errorText = await instancesResponse.text();
                    throw new Error(`HTTP ${instancesResponse.status}: ${errorText.substring(0, 100)}`);
                }
                
                const instancesData = await instancesResponse.json();
                console.log('Instances data:', instancesData);
                
                if (instancesData.error) {
                    throw new Error(`AWS Error: ${instancesData.error}`);
                }
                
                // Update dashboard with real data
                document.getElementById('monthly-cost').innerText = 
                    '$' + (costData.total_cost || '0');
                document.getElementById('cost-source').innerText = '(Real AWS Data)';
                document.getElementById('data-source').innerText = '(Real AWS Instances)';
                
                // Update summary cards
                document.getElementById('idle-resources').innerText = 
                    instancesData.total_instances || '0';
                document.getElementById('total-resources').innerText = 
                    instancesData.total_instances || '0';
                
                // Update chart with real dates and costs
                costChart.data.labels = costData.daily_costs?.map(d => d.date.substring(5)) || [];
                costChart.data.datasets[0].data = costData.daily_costs?.map(d => parseFloat(d.cost)) || [];
                costChart.update();
                
                // Update resources table with AWS instances
                updateResourcesTable(instancesData.idle_instances);
                
                // Show success and enable auto-refresh
                alert('‚úÖ AWS connected successfully! Auto-refresh enabled (5 minutes).');
                
                // Enable auto-refresh
                isAWSConnected = true;
                document.querySelector('.btn-connect').style.display = 'none';
                document.querySelector('.btn-disconnect').style.display = 'inline-block';
                document.getElementById('refresh-status').style.display = 'block';
                startAutoRefresh();
                
            } catch (error) {
                console.error('Full error:', error);
                alert('‚ùå Failed to connect AWS: ' + error.message);
            } finally {
                connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect AWS';
                connectBtn.disabled = false;
            }
        }

        // Disconnect AWS
        function disconnectAWS() {
            isAWSConnected = false;
            stopAutoRefresh();
            document.querySelector('.btn-connect').style.display = 'inline-block';
            document.querySelector('.btn-disconnect').style.display = 'none';
            document.getElementById('refresh-status').style.display = 'none';
            document.getElementById('cost-source').innerText = '(Demo Data)';
            document.getElementById('data-source').innerText = '(Demo Data)';
            loadDemoData();
            alert('üîå AWS disconnected. Auto-refresh stopped.');
        }

        // Auto-refresh functions
        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing intervals
            timeLeft = 300; // Reset to 5 minutes
            
            // Update timer every second
            refreshTimerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('refresh-timer').innerText = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    refreshAWSData();
                    timeLeft = 300; // Reset timer
                }
            }, 1000);
            
            // First refresh
            refreshAWSData();
            console.log('‚úÖ Auto-refresh enabled (every 5 minutes)');
        }
        
        function stopAutoRefresh() {
            if (refreshTimerInterval) {
                clearInterval(refreshTimerInterval);
                refreshTimerInterval = null;
            }
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            console.log('‚èπÔ∏è Auto-refresh disabled');
        }
        
        async function refreshAWSData() {
            const key = document.getElementById('aws-key').value.trim();
            const secret = document.getElementById('aws-secret').value.trim();
            
            if (!key || !secret || !isAWSConnected) return;
            
            try {
                console.log('üîÑ Auto-refreshing AWS data...');
                
                // Refresh cost data
                const costResponse = await fetch('https://cloudoptima.onrender.com/api/aws/cost', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({accessKeyId: key, secretAccessKey: secret})
                });
                
                if (!costResponse.ok) return;
                
                const costData = await costResponse.json();
                if (costData.error) return;
                
                // Silent update of chart
                costChart.data.labels = costData.daily_costs?.map(d => d.date.substring(5)) || [];
                costChart.data.datasets[0].data = costData.daily_costs?.map(d => parseFloat(d.cost)) || [];
                costChart.update();
                
                // Update last scan time
                document.getElementById('last-scan').innerText = new Date().toLocaleTimeString();
                
                console.log('‚úÖ Auto-refresh completed');
                
            } catch (error) {
                console.log('Auto-refresh failed:', error.message);
            }
        }

        // Function to update resources table with AWS instances
        function updateResourcesTable(instances) {
            const tableBody = document.getElementById('resources-body');
            tableBody.innerHTML = ''; // Clear demo data
            
            if (!instances || instances.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align:center; padding:20px;">
                            <i class="fas fa-check-circle" style="color:#28a745;"></i>
                            No idle instances found in your AWS account.
                        </td>
                    </tr>`;
                return;
            }
            
            instances.forEach(instance => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${instance.id}</td>
                    <td>${instance.name || 'No Name'}</td>
                    <td><span class="cloud-badge aws">AWS</span></td>
                    <td><span class="status-badge idle">IDLE</span></td>
                    <td>${instance.days_running} days</td>
                    <td>$${instance.estimated_savings || '50'}/month</td>
                    <td>
                        <button class="btn-action" onclick="sendAlert('${instance.id}')">
                            <i class="fas fa-bell"></i> Alert
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Demo mode toggle
        function toggleDemoMode() {
            const btn = document.getElementById('demo-btn');
            const isDemo = btn.innerText.includes('ON');
            
            if (isDemo) {
                btn.innerHTML = '<i class="fas fa-database"></i> Demo Mode: OFF';
                btn.style.background = '#28a745';
                document.getElementById('cost-source').innerText = '(Real AWS Data)';
                if (isAWSConnected) {
                    startAutoRefresh();
                }
            } else {
                btn.innerHTML = '<i class="fas fa-play-circle"></i> Demo Mode: ON';
                btn.style.background = '#007bff';
                document.getElementById('cost-source').innerText = '(Demo Data)';
                document.getElementById('data-source').innerText = '(Demo Data)';
                stopAutoRefresh();
                loadDemoData(); // Reload demo data
            }
        }

        // Cloud tabs
        function showCloud(cloud) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // Filter table by cloud
            console.log('Showing:', cloud);
        }

        // Existing functions
        function runScan() {
            alert('Scan feature requires backend connection. Use "Connect AWS" for real scan.');
        }

        function sendAlert(resourceId) {
            const email = prompt('Enter email for alerts:', 'team@yourcompany.com');
            if (!email) return;
            
            fetch('https://cloudoptima.onrender.com/api/alert/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    resource_id: resourceId,
                    email: email
                })
            })
            .then(res => res.json())
            .then(data => {
                alert(`‚úÖ ${data.message}`);
            })
            .catch(error => {
                alert('‚ùå Alert service unavailable. Using demo mode.');
                console.log('Demo alert for:', resourceId);
            });
        }

        // Load demo data on page load
        document.addEventListener('DOMContentLoaded', loadDemoData);
    </script>
</body>
</html> 