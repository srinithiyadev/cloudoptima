<!DOCTYPE html>
<html lang="en">
<head>
    <script>
    // PROTECT DASHBOARD - CHECK LOGIN
    if (!localStorage.getItem('demo_mode') && !localStorage.getItem('token')) {
        window.location.href = '/login.html';
    }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudOptima Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1><i class="fas fa-cloud"></i> CloudOptima Dashboard</h1>
            <div class="header-info">
                <p><i class="fas fa-clock"></i> Last scan: <span id="last-scan">Just now</span></p>
                <button onclick="runScan()" class="btn-scan">
                    <i class="fas fa-sync-alt"></i> Run Scan
                </button>
                <button onclick="toggleDemoMode()" class="btn-demo" id="demo-btn">
                    <i class="fas fa-play-circle"></i> Demo Mode: ON
                </button>
            </div>
            <div style="position: absolute; top: 20px; right: 30px; display: flex; align-items: center; gap: 15px;">
    <span style="color: #1e293b;" id="userEmail">
        <i class="fas fa-user-circle"></i> 
        <span id="userEmailText">demo@cloudoptima.com</span>
    </span>
    <button onclick="logout()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>
</div>
        </header>

        <!-- AWS Connection Panel -->
        <div class="aws-connect-card" id="aws-connect">
            <h3><i class="fab fa-aws"></i> Connect AWS Account (Optional)</h3>
            <p>Connect to see your real AWS cost data and idle instances</p>
            <div class="aws-inputs">
                <input type="text" id="aws-key" placeholder="AWS Access Key ID">
                <input type="password" id="aws-secret" placeholder="AWS Secret Key">
                <button onclick="connectAWS()" class="btn-connect">
                    <i class="fas fa-plug"></i> Connect AWS
                </button>
                <button onclick="disconnectAWS()" class="btn-disconnect" style="background:#dc3545;display:none;">
                    <i class="fas fa-unlink"></i> Disconnect
                </button>
            </div>
            <p class="small-note">
                <i class="fas fa-shield-alt"></i> Keys are used temporarily and never stored
            </p>
            <p id="refresh-status" class="small-note" style="display:none;">
                <i class="fas fa-sync-alt"></i> Auto-refresh: <span id="refresh-timer">5:00</span>
            </p>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card">
                <h3><i class="fas fa-server"></i> Total Resources</h3>
                <p class="big-number" id="total-resources">12</p>
            </div>
            <div class="card">
                <h3><i class="fas fa-bed"></i> Idle Resources</h3>
                <p class="big-number" id="idle-resources">3</p>
            </div>
            <div class="card highlight">
                <h3><i class="fas fa-money-bill-wave"></i> Monthly Cost</h3>
                <p class="big-number" id="monthly-cost">$1,250</p>
                <p class="cost-source" id="cost-source">(Demo Data)</p>
            </div>
        </div>

        <!-- Cost Chart -->
        <div class="chart-section">
            <h2><i class="fas fa-chart-line"></i> AWS Cost Overview</h2>
            <canvas id="costChart"></canvas>
        </div>

        <!-- Cloud Tabs -->
        <div class="cloud-tabs">
            <button class="tab-btn active" onclick="showCloud('aws')">
                <i class="fab fa-aws"></i> AWS
            </button>
            <button class="tab-btn" onclick="showCloud('azure')">
                <i class="fab fa-microsoft"></i> Azure
            </button>
            <button class="tab-btn" onclick="showCloud('gcp')">
                <i class="fab fa-google"></i> Google Cloud
            </button>
        </div>

        <!-- Resources Table -->
        <div class="table-section">
            <h2><i class="fas fa-list"></i> Cloud Resources <span id="data-source">(Demo Data)</span></h2>
            <table id="resources-table">
                <thead>
                    <tr>
                        <th>Resource ID</th>
                        <th>Name</th>
                        <th>Cloud</th>
                        <th>Status</th>
                        <th>Days Running</th>
                        <th>Monthly Cost</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resources-body">
                    <!-- Demo data will be loaded by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <footer>
            <p>CloudOptima &copy; 2024 | Multi-Cloud Cost Optimization Tool</p>
            <p class="footer-info">
                <i class="fas fa-info-circle"></i> 
                Connect AWS to see real cost data. Azure & GCP show demo data.
            </p>
        </footer>
    </div>

    <script>
        // Demo data
        const demoInstances = [
            {id: 'i-0abc123def456', name: 'Web Server', cloud: 'aws', status: 'running', days: '45', cost: '$85'},
            {id: 'i-1def456ghi789', name: 'Database', cloud: 'aws', status: 'idle', days: '120', cost: '$120'},
            {id: 'vm-prod-app-01', name: 'App Server', cloud: 'azure', status: 'running', days: '30', cost: '$95'},
            {id: 'vm-dev-test-02', name: 'Test VM', cloud: 'azure', status: 'idle', days: '90', cost: '$65'},
            {id: 'gcp-instance-1', name: 'Kubernetes Node', cloud: 'gcp', status: 'running', days: '15', cost: '$110'},
            {id: 'gcp-instance-2', name: 'Backup Server', cloud: 'gcp', status: 'idle', days: '200', cost: '$75'}
        ];

        // Auto-refresh variables
        let autoRefreshInterval = null;
        let refreshTimerInterval = null;
        let timeLeft = 300; // 5 minutes in seconds
        let isAWSConnected = false;

        // Load demo data on page load
        function loadDemoData() {
            const tableBody = document.getElementById('resources-body');
            tableBody.innerHTML = '';
            
            demoInstances.forEach(instance => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${instance.id}</td>
                    <td>${instance.name}</td>
                    <td><span class="cloud-badge ${instance.cloud}">${instance.cloud.toUpperCase()}</span></td>
                    <td><span class="status-badge ${instance.status}">${instance.status.toUpperCase()}</span></td>
                    <td>${instance.days} days</td>
                    <td>${instance.cost}/month</td>
                    <td>
                        ${instance.status === 'idle' ? 
                            `<button class="btn-action" onclick="sendAlert('${instance.id}')">
                                <i class="fas fa-bell"></i> Alert
                            </button>` : 
                            `<span class="text-muted">No action</span>`
                        }
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Chart for cost visualization
        const ctx = document.getElementById('costChart').getContext('2d');
        const costChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Will be populated with dates
                datasets: [{
                    label: 'AWS Daily Cost (USD)',
                    data: [],
                    borderColor: '#36a2eb',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {display: true, text: 'AWS Daily Costs (Last 30 Days)'}
                }
            }
        });

        // AWS Connection
        async function connectAWS() {
            const key = document.getElementById('aws-key').value.trim();
            const secret = document.getElementById('aws-secret').value.trim();
            
            console.log('Connecting with key:', key.substring(0, 8) + '...');
            
            if (!key || !secret) {
                alert('Please enter AWS Access Key and Secret Key');
                return;
            }

            const connectBtn = document.querySelector('.btn-connect');
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            connectBtn.disabled = true;
            
            try {
                // 1. Fetch cost data
                console.log('Fetching cost data...');
                const costResponse = await fetch('https://cloudoptima.onrender.com/api/aws/cost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        accessKeyId: key,
                        secretAccessKey: secret
                    })
                });
                
                console.log('Cost response status:', costResponse.status);
                
                if (!costResponse.ok) {
                    const errorText = await costResponse.text();
                    throw new Error(`HTTP ${costResponse.status}: ${errorText.substring(0, 100)}`);
                }
                
                const costData = await costResponse.json();
                console.log('Cost data received:', costData);
                
                if (costData.error) {
                    throw new Error(`AWS Error: ${costData.error}`);
                }
                
                // 2. Fetch AWS instances
                console.log('Fetching instances...');
                const instancesResponse = await fetch('https://cloudoptima.onrender.com/api/aws/instances', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        accessKeyId: key,
                        secretAccessKey: secret
                    })
                });
                
                console.log('Instances response status:', instancesResponse.status);
                
                if (!instancesResponse.ok) {
                    const errorText = await instancesResponse.text();
                    throw new Error(`HTTP ${instancesResponse.status}: ${errorText.substring(0, 100)}`);
                }
                
                const instancesData = await instancesResponse.json();
                console.log('Instances data:', instancesData);
                
                if (instancesData.error) {
                    throw new Error(`AWS Error: ${instancesData.error}`);
                }
                
                // Update dashboard with real data
                document.getElementById('monthly-cost').innerText = 
                    '$' + (costData.total_cost || '0');
                document.getElementById('cost-source').innerText = '(Real AWS Data)';
                document.getElementById('data-source').innerText = '(Real AWS Instances)';
                
                // Update summary cards
                document.getElementById('idle-resources').innerText = 
                    instancesData.total_instances || '0';
                document.getElementById('total-resources').innerText = 
                    instancesData.total_instances || '0';
                
                // Update chart with real dates and costs
                costChart.data.labels = costData.daily_costs?.map(d => d.date.substring(5)) || [];
                costChart.data.datasets[0].data = costData.daily_costs?.map(d => parseFloat(d.cost)) || [];
                costChart.update();
                
                // Update resources table with AWS instances
                updateResourcesTable(instancesData.idle_instances);
                
                // Show success and enable auto-refresh
                alert('‚úÖ AWS connected successfully! Auto-refresh enabled (5 minutes).');
                
                // Enable auto-refresh
                isAWSConnected = true;
                document.querySelector('.btn-connect').style.display = 'none';
                document.querySelector('.btn-disconnect').style.display = 'inline-block';
                document.getElementById('refresh-status').style.display = 'block';
                startAutoRefresh();
                
            } catch (error) {
                console.error('Full error:', error);
                alert('‚ùå Failed to connect AWS: ' + error.message);
            } finally {
                connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect AWS';
                connectBtn.disabled = false;
            }
        }

        // Disconnect AWS
        function disconnectAWS() {
            isAWSConnected = false;
            stopAutoRefresh();
            document.querySelector('.btn-connect').style.display = 'inline-block';
            document.querySelector('.btn-disconnect').style.display = 'none';
            document.getElementById('refresh-status').style.display = 'none';
            document.getElementById('cost-source').innerText = '(Demo Data)';
            document.getElementById('data-source').innerText = '(Demo Data)';
            loadDemoData();
            alert('üîå AWS disconnected. Auto-refresh stopped.');
        }

        // Auto-refresh functions
        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing intervals
            timeLeft = 300; // Reset to 5 minutes
            
            // Update timer every second
            refreshTimerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('refresh-timer').innerText = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    refreshAWSData();
                    timeLeft = 300; // Reset timer
                }
            }, 1000);
            
            // First refresh
            refreshAWSData();
            console.log('‚úÖ Auto-refresh enabled (every 5 minutes)');
        }
        
        function stopAutoRefresh() {
            if (refreshTimerInterval) {
                clearInterval(refreshTimerInterval);
                refreshTimerInterval = null;
            }
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            console.log('‚èπÔ∏è Auto-refresh disabled');
        }
        
        async function refreshAWSData() {
            const key = document.getElementById('aws-key').value.trim();
            const secret = document.getElementById('aws-secret').value.trim();
            
            if (!key || !secret || !isAWSConnected) return;
            
            try {
                console.log('üîÑ Auto-refreshing AWS data...');
                
                // Refresh cost data
                const costResponse = await fetch('https://cloudoptima.onrender.com/api/aws/cost', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({accessKeyId: key, secretAccessKey: secret})
                });
                
                if (!costResponse.ok) return;
                
                const costData = await costResponse.json();
                if (costData.error) return;
                
                // Silent update of chart
                costChart.data.labels = costData.daily_costs?.map(d => d.date.substring(5)) || [];
                costChart.data.datasets[0].data = costData.daily_costs?.map(d => parseFloat(d.cost)) || [];
                costChart.update();
                
                // Update last scan time
                document.getElementById('last-scan').innerText = new Date().toLocaleTimeString();
                
                console.log('‚úÖ Auto-refresh completed');
                
            } catch (error) {
                console.log('Auto-refresh failed:', error.message);
            }
        }

        // Function to update resources table with AWS instances
        function updateResourcesTable(instances) {
            const tableBody = document.getElementById('resources-body');
            tableBody.innerHTML = ''; // Clear demo data
            
            if (!instances || instances.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align:center; padding:20px;">
                            <i class="fas fa-check-circle" style="color:#28a745;"></i>
                            No idle instances found in your AWS account.
                        </td>
                    </tr>`;
                return;
            }
            
            instances.forEach(instance => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${instance.id}</td>
                    <td>${instance.name || 'No Name'}</td>
                    <td><span class="cloud-badge aws">AWS</span></td>
                    <td><span class="status-badge idle">IDLE</span></td>
                    <td>${instance.days_running} days</td>
                    <td>$${instance.estimated_savings || '50'}/month</td>
                    <td>
                        <button class="btn-action" onclick="sendAlert('${instance.id}')">
                            <i class="fas fa-bell"></i> Alert
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Demo mode toggle
        function toggleDemoMode() {
            const btn = document.getElementById('demo-btn');
            const isDemo = btn.innerText.includes('ON');
            
            if (isDemo) {
                btn.innerHTML = '<i class="fas fa-database"></i> Demo Mode: OFF';
                btn.style.background = '#28a745';
                document.getElementById('cost-source').innerText = '(Real AWS Data)';
                if (isAWSConnected) {
                    startAutoRefresh();
                }
            } else {
                btn.innerHTML = '<i class="fas fa-play-circle"></i> Demo Mode: ON';
                btn.style.background = '#007bff';
                document.getElementById('cost-source').innerText = '(Demo Data)';
                document.getElementById('data-source').innerText = '(Demo Data)';
                stopAutoRefresh();
                loadDemoData(); // Reload demo data
            }
        }

        // Cloud tabs
        function showCloud(cloud) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // Filter table by cloud
            console.log('Showing:', cloud);
        }

        // Existing functions
        function runScan() {
            alert('Scan feature requires backend connection. Use "Connect AWS" for real scan.');
        }

        function sendAlert(resourceId) {
            const email = prompt('Enter email for alerts:', 'team@yourcompany.com');
            if (!email) return;
            
            fetch('https://cloudoptima.onrender.com/api/alert/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    resource_id: resourceId,
                    email: email
                })
            })
            .then(res => res.json())
            .then(data => {
                alert(`‚úÖ ${data.message}`);
            })
            .catch(error => {
                alert('‚ùå Alert service unavailable. Using demo mode.');
                console.log('Demo alert for:', resourceId);
            });
        }

        // Load demo data on page load
        document.addEventListener('DOMContentLoaded', loadDemoData);
    </script>
</body>
</html>